# Copyright 2018-2021 Cargill Incorporated
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

openapi: '3.0.0'

info:
  version: 0.4.2
  title: splinterd API
  description: REST API for the Splinter daemon

servers:
  - url: http://localhost:9000/api

paths:
  /status:
    get:
      tags:
        - diagnostics
      description: Used to check if server is successfully running
      parameters:
        - $ref: "#/components/parameters/protocol_version"
      responses:
        200:
          description: Server is running correctly and accepting connections
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Status'
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/proposals:
    get:
      summary: Fetches a list of pending circuit proposals for this node
      description: |
        This endpoint can be used to view all of the circuit proposals that the
        node is a proposed member of. If a circuit management type is provided
        via the "management_type" query parameter, only circuit proposals that
        have the given circuit management type will be returned. If a node ID is
        provided via the "member" query parameter, only circuit proposals that
        have the given node as a member will be returned. If no filter is
        provided, all of the node's circuit proposals will be returned.
      tags:
        - Proposals
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: offset
          in: query
          description: paging offset
          required: false
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          description: maximum number of items to return (max 100)
          required: false
          schema:
            type: integer
            default: 100
        - name: management_type
          in: query
          description: |-
            Only show proposed circuits matching the given circuit management
            type
          required: false
          schema:
            type: string
        - name: member
          in: query
          description: |-
            Only show proposed circuits that have a member with the given node
            ID
          required: false
          schema:
            type: string
      responses:
        200:
          description: Successfully retrieved the list of proposals
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Proposal'
                  paging:
                    $ref: '#/components/schemas/Paging'
        400:
          description: Request was malformed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurrred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/proposals/{circuit_id}:
    get:
      summary: Fetches a circuit proposal by the circuit's ID
      description: |
        This endpoint can be used to view a specific circuit proposal that the
        node is a proposed member of.
      tags:
        - Proposals
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: circuit_id
          in: path
          description: Circuit ID of the proposal to fetch
          required: true
          schema:
            type: string
      responses:
        200:
          description: Successfully retrieved the requested proposal
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Proposal"
        404:
          description: The requested circuit proposal was not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurrred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/submit:
    post:
      tags:
        - Admin Service
      description: Send circuit management payload in bytes to admin service
      parameters:
        - $ref: "#/components/parameters/protocol_version"
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        202:
          description: The circuit management payload was accepted
        400:
          description: Request was malformed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'


  /ws/admin/register/{type}:
    get:
      tags:
        - Admin Service
      description: Register the handler for a circuit management type
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: type
          description: The circuit management type is the type of circuit the handler will manage
          in: path
          required: true
          schema:
            type: string
          x-example: gameroom
        - name: last
          description: A timestamp in milliseconds from the Unix Epoch, indicating the last received event.
          in: query
          required: false
          schema:
            type: integer
            default: 0
      responses:
        200:
          description: Registration request was successfully submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApplicationRegistration'
        400:
          description: The circuit management type was invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/circuits:
    get:
      summary: Fetches a list of circuits that the node belongs to
      description: |
        This endpoint can be used to view all or some of the circuits that the
        node is a member of. If a node ID is provided via the "filter" query
        parameter, only circuits that have the given node ID as a member will be
        returned; if no filter is provided, all of the node's circuits will be
        returned.
      tags:
        - Circuits
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: offset
          in: query
          description: paging offset
          required: false
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          description: maximum number of items to return (max 100)
          required: false
          schema:
            type: integer
            default: 100
        - name: filter
          in: query
          description: Node ID that must be present in the returned circuits
          required: false
          schema:
            type: string
      responses:
        200:
          description: Successfully retrieved the list of circuits
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Circuit'
                  paging:
                    $ref: '#/components/schemas/Paging'
        400:
          description: Request was malformed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurrred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/circuits/{circuit_id}:
    get:
      summary: Fetches a circuit by its ID
      description: |
        This endpoint can be used to view a specific circuit that the node is a
        member of.
      tags:
        - Circuits
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: circuit_id
          in: path
          description: ID of the circuit to fetch
          required: true
          schema:
            type: string
      responses:
        200:
          description: Successfully retrieved the requested circuit
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Circuit"
        404:
          description: The requested circuit was not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurrred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /registry/nodes:
    post:
      summary: Add a node to the registry
      description: |
        This endpoint can be used to add a new node to the Splinter registry.
        The node must be valid (see the Splinter registry documentation for
        details on node validity).
      tags:
        - Splinter Registry
      parameters:
        - $ref: "#/components/parameters/protocol_version"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisteredNode'
      responses:
        200:
          description: The node was successfully added to the registry
        400:
          description: The request was malformed or the node was invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      summary: List nodes in the registry
      description: |
        This endpoint can be used to view all or some of the nodes in the
        registry. If metadata filters are provided via the "filter" query
        parameter, only nodes that match the given filters will be returned. See
        the Splinter registry documentation for details on metadata filters.
      tags:
        - Splinter Registry
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: offset
          in: query
          description: paging offset
          required: false
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          description: maximum number of items to return (max 100)
          required: false
          schema:
            type: integer
            default: 100
        - name: filter
          in: query
          description: |
            url-encodeded stringified JSON containing property filters on the
            node's metadata properties in the format
              {METADATA_PROPERTY:[{"operator":OPERATOR,"value":VALUE}]}
          required: false
          schema:
            type: string
          example: "%7B%22company%22%3A%5B%22%3D%22%2C%22Cargill%22%5D%7D"
      responses:
        200:
          description: The list of nodes was successfully retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/RegisteredNode'
                  paging:
                    $ref: '#/components/schemas/Paging'
        400:
          description: The request was malformed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /registry/nodes/{identity}:
    get:
      summary: Fetch a node in the registry by its identity
      description: |
        This endpoint can be used to view a specific nodes in the registry.
      tags:
        - Splinter Registry
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: identity
          in: path
          description: identity of node to fetch
          required: true
          schema:
            type: string
      responses:
        200:
          description: The node was successfully retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/RegisteredNode"
        404:
          description: The node was not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: Add or replace a node in the registry
      description: |
        This endpoint can be used to add a new node to the registry, or replace
        an existing node. When replacing an existing node, the node identity
        cannot be changed. This action is idempotent.
      tags:
        - Splinter Registry
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: identity
          in: path
          description: identity of node to add/replace
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisteredNode'
      responses:
        200:
          description: The node has been added or replaced
        400:
          description: The request was malformed or the node was invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: Delete a node from the registry
      description: This endpoint can be used to remove a node from the registry.
      tags:
        - Splinter Registry
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: identity
          in: path
          description: identity of node to delete
          required: true
          schema:
            type: string
      responses:
        200:
          description: The node has been deleted from the registry
        404:
          description: The node was not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /scabbard/{circuit}/{service_id}/batches:
    post:
      summary: Submit a list of batches to the Scabbard service
      description: |
        This endpoint can be used to submit batches to a Scabbard service. The
        body of the request must be a list of valid Sabre batches. If the
        batches are submitted successfully, the response will contain a link for
        checking the status of the submitted batches.
      tags:
        - Scabbard
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: circuit
          in: path
          description: Circuit the targeted service belongs to
          required: true
          schema:
            type: string
        - name: service_id
          in: path
          description: ID of the targeted service
          required: true
          schema:
            type: string
      responses:
        202:
          description: Batch was submitted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Link"
        400:
          description: No batches were provided
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        404:
          description: |
            The scabbard service with the given circuit and service id was not
            found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /scabbard/{circuit}/{service_id}/batch_statuses:
    get:
      summary: Get the statuses of a list of batches
      description: |
        This endpoint can be used to check the status of one or more batches
        that were submitted to a Scabbard service. The IDs of the batches to
        check should be specified with the `ids` query parameter. The `wait`
        query parameter requests that the server wait for the given number of
        seconds for the batches to be committed; however, this wait time is not
        guaranteed.
      tags:
        - Scabbard
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: circuit
          in: path
          description: Circuit the targeted service belongs to
          required: true
          schema:
            type: string
        - name: service_id
          in: path
          description: ID of the targeted service
          required: true
          schema:
            type: string
        - name: ids
          in: query
          description: Comma-separated list of batch IDs
          required: true
          schema:
            type: string
        - name: wait
          in: query
          description: |
            Time (in seconds) to wait for batches to be committed. If not
            provided, the server will return the batch statuses immediately. If
            the parameter is provided without a value, the default time (300
            seconds) will be used.
          required: false
          schema:
            type: integer
            default: 300
      responses:
        200:
          description: The statuses of the batches were successfully retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BatchStatus'
        400:
          description: The request was malformed or no batch IDs were provided
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        404:
          description: |
            The scabbard service with the given circuit and service id was not
            found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        408:
          description: |
            The batches were not committed before the specified wait time
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /scabbard/{circuit}/{service_id}/state:
    get:
      summary: Get a list of entries from a Scabbard service's state
      description: |
        This endpoint can be used to fetch a list of entries from a Scabbard
        service's state. The entries can be filtered using an address prefix
        provided with the `prefix` query parameter.
      tags:
        - Scabbard
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: circuit
          in: path
          description: Circuit the targeted service belongs to
          required: true
          schema:
            type: string
        - name: service_id
          in: path
          description: ID of the targeted service
          required: true
          schema:
            type: string
        - name: prefix
          in: query
          description: |
            An address prefix for filtering state entries. If no prefix is
            specified, all state entries will be returned.
          required: false
          schema:
            type: string
            example: 00ec01
      responses:
        200:
          description: The state entries were successfully retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    address:
                      type: string
                    value:
                      type: array
                      items:
                        type: integer
        400:
          description: The request was malformed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        404:
          description: |
            The scabbard service with the given circuit and service id was not
            found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /scabbard/{circuit}/{service_id}/state/{address}:
    get:
      summary: Get the value at an address in a Scabbard service's state
      description: |
        This endpoint can be used to fetch the value at a specific address in a
        Scabbard service's state.
      tags:
        - Scabbard
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: circuit
          in: path
          description: Circuit the targeted service belongs to
          required: true
          schema:
            type: string
        - name: service_id
          in: path
          description: ID of the targeted service
          required: true
          schema:
            type: string
        - name: address
          in: path
          description: The address of the value to retrieve from state
          required: true
          schema:
            type: string
            example: 000000a87cb5eafdcca6a814e4add97c4b517d3c530c2f44b31d18e3b0c44298fc1c14
      responses:
        200:
          description: The value was successfully retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  type: integer
        400:
          description: The request was malformed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        404:
          description: |
            The scabbard service with the given circuit and service id was not
            found, or there is no value at the given address
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        500:
          description: An internal server error occurred
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /biome/register:
    post:
      tags:
        - Biome
      description: Create new user with username and password credentials
      parameters:
        - $ref: "#/components/parameters/protocol_version"
      requestBody:
        content:
          application/json:
            schema:
              properties:
                username:
                  description: username of a new user
                hashed_password:
                  description: |
                     Hashed password to be used for user authentication
              required:
                - username
                - hashed_password
              example:
                username: alice@acme.com
                hashed_password: F4AABE0B40C9ABB8B6FD2EEACB39C965
      responses:
        200:
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "User created successfully"
                  data:
                    type: object
                    example:
                      ref: '#/components/schemas/BiomeNewUser'
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'

  /biome/login:
    post:
      tags:
        - Biome
      description: Authenticates a user with username and password credentials
      parameters:
        - $ref: "#/components/parameters/protocol_version"
      requestBody:
        content:
          application/json:
            schema:
              properties:
                username:
                  description: username of user
                hashed_password:
                  description: |
                    Hashed password to be used for user authentication

              required:
                - username
                - hashed_password
              example:
                username: alice@acme.com
                hashed_password: |-
                  8945622435187243046536949706b5272644c71336c7254563679727565494b376d4b3554696b734662685962652f6v52562e437a70462f6552489c8b
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Successful login"
                  user_id:
                    type: string
                    description: "Internal unique identifier for the user"
                    example: "f35aacc1-a9cd-4eda-b6d0-2efaddf0c8a4"
                  token:
                    type: string
                    description: "JWT access token used for authorizing access to protected resources"
                    example: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lk\
                      IjoiZjM1YWFjYzEtYTljZC00ZWRhLWI2ZDAtMmVmYWRkZjBjOGE0Iiwia\
                      XNzIjoic2VsZi1pc3N1ZWQiLCJleHAiOjE1ODAyMzkyMjh9.P8hA0ru_x\
                      riYX7qryl08ZEp86t5HD_AEVPEUXY70Ehc"
                  refresh_token:
                    type: string
                    description: "JWT refresh token used for obtaining a new access to token"
                    example: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lk\
                      IjoiZjM1YWFjYzEtYTljZC00ZWRhLWI2ZDAtMmVmYWRkZjBjOGE0Iiwia\
                      XNzIjoic2VsZi1pc3N1ZWQiLCJleHAiOjE1ODAyMzkyMjh9.P8hA0ru_x\
                      riYX7qryl08ZEp86t5HD_AEVPEUXY70Ehc"
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'

  /biome/logout:
    patch:
      tags:
        - Biome
      description: Removes access tokens associated with a user
      parameters:
        - $ref: "#/components/parameters/protocol_version"
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "User successfully logged out"
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        401:
          description: Access token is invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'

  /biome/token:
    post:
      tags:
        - Biome
      description: Issues a new access token
      parameters:
        - $ref: "#/components/parameters/protocol_version"
      requestBody:
        content:
          application/json:
            schema:
              properties:
                refresh_token:
                  description: a refresh token issues by biome

              required:
                - refresh_token
              example:
                refresh_token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lk\
                  IjoiZjM1YWFjYzEtYTljZC00ZWRhLWI2ZDAtMmVmYWRkZjBjOGE0Iiwia\
                  XNzIjoic2VsZi1pc3N1ZWQiLCJleHAiOjE1ODAyMzkyMjh9.P8hA0ru_x\
                  riYX7qryl08ZEp86t5HD_AEVPEUXY70Ehc"
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: "JWT access token used for authorizing access to protected resources"
                    example: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lk\
                      IjoiZjM1YWFjYzEtYTljZC00ZWRhLWI2ZDAtMmVmYWRkZjBjOGE0Iiwia\
                      XNzIjoic2VsZi1pc3N1ZWQiLCJleHAiOjE1ODAyMzkyMjh9.P8hA0ru_x\
                      riYX7qryl08ZEp86t5HD_AEVPEUXY70Ehc"
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        401:
          description: Access token is invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorBiome'
        403:
          description: Refresh token is invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'

  /biome/verify:
    post:
      tags:
        - Biome
      description: Verifies a user with username and password credentials
      parameters:
        - $ref: "#/components/parameters/protocol_version"
      requestBody:
        content:
          application/json:
            schema:
              properties:
                username:
                  description: username of user
                hashed_password:
                  description: |
                    Hashed password to be used for user authentication
              required:
                - username
                - hashed_password
              example:
                username: alice@acme.com
                hashed_password: |-
                  8945622435187243046536949706b5272644c71336c7254563679727565494b376d4b3554696b734662685962652f6v52562e437a70462f6552489c8b
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Successful verification"
                  user_id:
                    type: string
                    description: "Internal unique identifier for the user"
                    example: "f35aacc1-a9cd-4eda-b6d0-2efaddf0c8a4"
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        401:
          description: Unauthorized request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'

  /biome/users:
    get:
      tags:
        - Biome
      description: Lists all users
      parameters:
        - $ref: "#/components/parameters/protocol_version"
      responses:
        200:
          description: List of users registered in Biome
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    username:
                      type: string
                      description: "Username used for login"
                      example: "alice@acme.com"
                    user_id:
                      type: string
                      description: "Internal unique identifier for the user"
                      example: "f35aacc1-a9cd-4eda-b6d0-2efaddf0c8a4"
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'

  /biome/users/{user_id}:
    get:
      tags:
      - Biome
      description: Fetch a user by ID
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: user_id
          in: path
          description: ID of the user
          required: true
          schema:
            type: string
            example: "f35aacc1-a9cd-4eda-b6d0-2efaddf0c8a4"
      responses:
        200:
          description: User information
          content:
            application/json:
              schema:
                type: object
                properties:
                  username:
                    type: string
                    description: "Username used for login"
                    example: "alice@acme.com"
                  user_id:
                    type: string
                    description: "Internal unique identifier for the user"
                    example: "f35aacc1-a9cd-4eda-b6d0-2efaddf0c8a4"
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        404:
          description: Resource not found
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
    put:
      tags:
      - Biome
      description: Update a user
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: user_id
          in: path
          description: ID of the user
          required: true
          schema:
            type: string
            example: "f35aacc1-a9cd-4eda-b6d0-2efaddf0c8a4"
      requestBody:
        content:
          application/json:
            schema:
              properties:
                username:
                  description: Existing username of user
                hashed_password:
                  description: |
                    Hashed password to be used for user authentication
                new_password:
                  description: |
                    Hash of the new password to be used for user authentication
                new_key_pairs:
                    type: array
                    items:
                      $ref: '#/components/schemas/BiomeNewUserKey'
              required:
                - username
                - hashed_password
                - display_name
                - public_key
                - encrypted_private_key
              example:
                username: alice@acme.com
                hashed_password: |-
                  8945622435187243046536949706b5272644c71336c7254563679727565494b376d4b3554696b734662685962652f6v52562e437a70462f6552489c8b
      responses:
        200:
          description: User updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Credentials and key updated successfully"
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/BiomeUserKey'
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        401:
          description: Unauthorized request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        404:
          description: Resource not found
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
    delete:
      tags:
        - Biome
      description: Delete a user
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: user_id
          in: path
          description: ID of the user
          required: true
          schema:
            type: string
            example: "f35aacc1-a9cd-4eda-b6d0-2efaddf0c8a4"
      responses:
        200:
          description: User deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "User deleted successfully"
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        401:
          description: Unauthorized request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        404:
          description: User with {user_id} not found
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'

  /biome/keys:
    get:
      tags:
      - Biome
      description: List keys of a user
      parameters:
        - $ref: "#/components/parameters/protocol_version"
      responses:
        200:
          description: User's keys
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BiomeUserKey'
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        401:
          description: User not authorized
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
    patch:
      tags:
      - Biome
      description: Update a key's display name
      parameters:
        - $ref: "#/components/parameters/protocol_version"
      requestBody:
        content:
          application/json:
            schema:
              properties:
                public_key:
                  description: Public key
                new_display_name:
                  description: |
                    Updated display name for the key
              required:
                - public_key
                - new_display_name
              example:
                public_key: "026c889058c2d22558ead2c61b321634b74e705c42f890e6b7bc2c80abb4713118"
                new_display_name: |-
                  Admin key pair
      responses:
        200:
          description: User updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Key updated successfully"
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        401:
          description: User not authorized
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        404:
          description: Resource not found
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
    post:
      tags:
      - Biome
      description: Add a new key for user
      parameters:
        - $ref: "#/components/parameters/protocol_version"
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BiomeUserKey'
      responses:
        200:
          description: User added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Key added successfully"
                  data:
                    $ref: '#/components/schemas/BiomeUserKey'
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        401:
          description: User not authorized
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'

  /biome/keys/{public_key}:
    get:
      tags:
      - Biome
      description: Fetch key of a user
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: public_key
          in: path
          description: Public key of the user
          required: true
          schema:
            type: string
            example: "026c889058c2d22558ead2c61b321634b74e705c42f890e6b7bc2c80abb4713118"
      responses:
        200:
          description: User's key
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/BiomeUserKey'
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        401:
          description: User not authorized
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        404:
          description: Resource not found
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
    delete:
      tags:
      - Biome
      description: Delete key of a user
      parameters:
        - $ref: "#/components/parameters/protocol_version"
        - name: user_id
          in: path
          description: ID of the user
          required: true
          schema:
            type: string
            example: "f35aacc1-a9cd-4eda-b6d0-2efaddf0c8a4"
        - name: public_key
          in: path
          description: Public key of the user
          required: true
          schema:
            type: string
            example: "026c889058c2d22558ead2c61b321634b74e705c42f890e6b7bc2c80abb4713118"
      responses:
        200:
          description: User's key deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "User deleted successfully"
                  data:
                    $ref: '#/components/schemas/BiomeUserKey'
        400:
          description: Invalid request
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        401:
          description: User not authorized
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        404:
          description: Resource not found
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'
        500:
          description: Internal server error occurred
          content:
            application/json:
                schema:
                  $ref: '#/components/schemas/ErrorBiome'

components:
  parameters:
    protocol_version:
      name: SplinterProtocolVersion
      in: header
      description: |
        The protocol version which the client can understand. If not provided,
        the node will respond using its latest protocol version.
      required: false
      schema:
        type: integer
        example: 1

  schemas:
    Error:
      additionalProperties: false
      properties:
        message:
          description: A message describing the error that occurred
          type: string
          example: DatabaseError({description})
      required:
        - message

    ErrorBiome:
      additionalProperties: false
      properties:
        code:
          description: Error code
          type: string
          example: 400
        message:
          description: A message describing the error that occurred
          type: string
          example: "Invalid payload"
      required:
        - message

    Status:
      additionalProperties: false
      properties:
        version:
          description: Rest API version
          type: string
          example: "0.4.2"
        node_id:
          description: Node id
          type: string
          example: node-009
        display_name:
          description: Human-readable name for the node
          type: string
          example: Cargill Node 009
        service_endpoint:
          description: The node's service endpoint
          example: tcp://foo.bar.biz
        network_endpoints:
          description: The node's locally-bound network endpoints
          type: array
          items:
            type: string
            example: tcp://foo.bar.biz
        advertised_endpoints:
          description: The node's network endpoints that are publicly accessible
          type: array
          items:
            type: string
            example: tcp://foo.bar.biz
      required:
        - version

    ApplicationRegistration:
      additionalProperties: false
      properties:
        status:
          description: Registration status
          type: string
          enum:
            - OK
            - ERROR
        circuit_management_type:
          description: Circuit management type
          type: string
          example: gameroom
        error_reason:
          description: Error message if the registration failed
          type: string

    RegisteredNode:
      type: object
      properties:
        identity:
          type: string
        endpoints:
          type: array
          items:
            type: string
        display_name:
          type: string
        keys:
          type: array
          items:
            type: string
        metadata:
          type: object
      example:
        identity: node-123123-asdf
        endpoints:
          - tcps://12.0.0.123:8431
        display_name: Cargill - Node 1
        keys:
          - "03e0e5086beffc640ec0d149d4f1197fdde0f338afac774541831281c6fd91cbe0"
        metadata:
          company: Cargill
          status: Up

    Link:
      type: object
      properties:
        link:
          type: string
          description: Link to get status of batches that were submitted
          example: "/scabbard/abcde-01234/ABCD/batch_statuses?ids=6ff35474a572087e08fd6a54d563bd8172951b363e5c9731f1a40a855e14bba45dac515364a08d8403f4fb5d4a206174b7f63c29e4f4e425dc71b95494b8a798"

    BatchStatus:
      type: object
      properties:
        id:
          type: string
          description: The batch's ID
          example: 6ff35474a572087e08fd6a54d563bd8172951b363e5c9731f1a40a855e14bba45dac515364a08d8403f4fb5d4a206174b7f63c29e4f4e425dc71b95494b8a798
        status:
          type: object
          description: Batch status
          properties:
            statusType:
              type: string
              enum:
                - Unknown
                - Invalid
                - Valid
                - Pending
                - Committed
            message:
                type: array
                items:
                  type: object
                  properties:
                    transaction_id:
                      type: string
                      example: f4e147ff464013deccb3e68bb8619beffb29ff86b401257c93bcf8ef76d7ca173fa84b4f4a58414ad2d00a2c9f810cbb726e01cd26ebd44720239d9d35853099
                    error_message:
                      type: string
                      example: "Wasm contract returned invalid transaction: xo, 0.3.3"
                    error_data:
                      type: array
                      items:
                        type: integer

    Circuit:
      type: object
      properties:
        id:
          type: string
          example: 01234-ABCDE
        members:
          description: Node IDs of the circuit's members
          type: array
          items:
            type: string
            example: alpha-node-000
        roster:
          description: All services defined for the circuit
          type: array
          items:
            $ref: '#/components/schemas/CircuitService'
        management_type:
          type: string
          example: gameroom

    CircuitService:
      type: object
      properties:
        service_id:
          type: string
          example: abcd
        service_type:
          type: string
          example: scabbard
        allowed_nodes:
          description: IDs of the nodes that are allowed to run this service
          type: array
          items:
            type: string

    Proposal:
      type: object
      properties:
        proposal_type:
          type: string
          enum:
            - Create
            - UpdateRoster
            - AddNode
            - RemoveNode
            - Destroy
        circuit_id:
          type: string
          example: 01234-ABCDE
        circuit_hash:
          type: string
          example: 8ce518770b962429a953b10220905ac9adf86a855f0b085695f444edf991b8ca
        circuit:
            type: object
            properties:
              circuit_id:
                type: string
                example: 01234-ABCDE
              members:
                type: array
                items:
                  $ref: '#/components/schemas/ProposedCircuitMember'
              roster:
                type: array
                items:
                  $ref: '#/components/schemas/ProposedCircuitService'
              management_type:
                type: string
                example: gameroom
              application_metadata:
                type: string
                format: binary
              comments:
                description: Arbitrary comments to describe the proposed circuit
                type: string
        votes:
          type: array
          items:
            $ref: '#/components/schemas/Vote'
        requester:
          type: string
          example: 026c889058c2d22558ead2c61b321634b74e705c42f890e6b7bc2c80abb4713118
        requester_node_id:
          type: string
          example: alpha-node-000

    ProposedCircuitMember:
      type: object
      properties:
        node_id:
          type: string
          example: alpha-node-000
        endpoints:
          type: array
          items:
            type: string
            example: tcps://12.0.0.123:8431

    ProposedCircuitService:
      type: object
      properties:
        service_id:
          type: string
          example: abcd
        service_type:
          type: string
          example: scabbard
        allowed_nodes:
          description: List of node IDs that are allowed to run this service
          type: array
          items:
            type: string
            example: alpha-node-000
        arguments:
          description: |-
            Arbitrary arguments to be passed to this service on initialization,
            formatted as an array of (key, value) pairs
          type: array
          items:
            type: array
            items:
              type: string
            minItems: 2
            maxItems: 2

    Vote:
      type: object
      properties:
        public_key:
          type: string
          example: 026c889058c2d22558ead2c61b321634b74e705c42f890e6b7bc2c80abb4713118
        vote:
          type: string
          enum:
            - Accept
            - Reject
        voter_node_id:
          type: string
          example: alpha-node-000

    Paging:
      type: object
      properties:
        current:
          type: string
        offset:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        first:
          type: string
        prev:
          type: string
        next:
          type: string
        last:
          type: string
      example:
        current: /registry/nodes?offset=10&limit=10
        offset: 10
        limit: 10
        total: 50
        first: /registry/nodes?offset=0&limit=10
        prev: /registry/nodes?offset=0&limit=10
        next: /registry/nodes?offset=20&limit=10
        last: /registry/nodes?offset=40&limit=10

    BiomeUserKey:
      type: object
      properties:
        display_name:
          type: string
          description: "Display name for key"
          example: "Biome Admin Key"
        encrypted_private_key:
          type: string
          description: "Encrypted private key"
          example: "XNzIjoic2VsZi1pc3N1ZWQiLCJleHAiOjE1ODAyMzkyMjh9.P8hA0ru_x\
            riYX7qryl08ZEp86t5HD_AEVPEUXY70Ehc"
        public_key:
          type: string
          description: "Public key"
          example: "026c889058c2d22558ead2c61b321634b74e705c42f890e6b7bc2c80abb4713118"
        user_id:
          type: string
          description: "Internal unique identifier for the user"
          example: "f35aacc1-a9cd-4eda-b6d0-2efaddf0c8a4"

    BiomeNewUserKey:
      type: object
      properties:
        display_name:
          type: string
          description: "Display name for key"
          example: "Biome Admin Key"
        encrypted_private_key:
          type: string
          description: "Encrypted private key"
          example: "XNzIjoic2VsZi1pc3N1ZWQiLCJleHAiOjE1ODAyMzkyMjh9.P8hA0ru_x\
            riYX7qryl08ZEp86t5HD_AEVPEUXY70Ehc"
        public_key:
          type: string
          description: "Public key"
          example: "026c889058c2d22558ead2c61b321634b74e705c42f890e6b7bc2c80abb4713118"

    BiomeCredentials:
      type: object
      properties:
        user_id:
          type: string
          description: "Internal unique identifier for the user"
          example: "f35aacc1-a9cd-4eda-b6d0-2efaddf0c8a4"
        username:
          type: string
          description: "Username of a user"
          example: "bob@biome.com"


tags:
  - name: Biome
    description: Routes supporting user management in Splinter applications. Optionally compiled.
